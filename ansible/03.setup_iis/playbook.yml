- name: Setup IIS Web Server
  hosts: windows
  gather_facts: yes
  vars:
    website_name: "Default Web Site"
    website_port: 80
    website_path: "C:\\inetpub\\wwwroot"
    
  tasks:
    - name: Install IIS Web Server role
      ansible.windows.win_feature:
        name: Web-Server
        include_management_tools: yes
        include_sub_features: yes
        state: present
      register: iis_install
      async: 600
      poll: 15

    - name: Verify IIS features installation
      ansible.windows.win_powershell:
        script: |
          Import-Module ServerManager
          $features = Get-WindowsFeature | Where-Object {$_.Name -like "IIS-*" -and $_.InstallState -eq "Installed"}
          $Ansible.Result = "checked"

    - name: Reboot if IIS installation requires it
      ansible.windows.win_reboot:
        reboot_timeout: 300
      when: iis_install.reboot_required

    - name: Ensure IIS service is running
      ansible.windows.win_service:
        name: W3SVC
        state: started
        start_mode: auto

    - name: Create main web page
      ansible.windows.win_copy:
        dest: "{{ website_path }}\\index.html"
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Rafael Automation Task - IIS Server</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background-color: #0078d4; color: white; padding: 20px; text-align: center; }
                  .content { padding: 20px; }
                  .info { background-color: #f0f0f0; padding: 15px; margin: 10px 0; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>Welcome to Rafael's IIS Server</h1>
                  <p>Automation Task - Job Interview Demo</p>
              </div>
              <div class="content">
                  <h2>Server Information</h2>
                  <div class="info">
                      <p><strong>Domain:</strong> rafael.local</p>
                      <p><strong>Server Role:</strong> Domain Controller + Web Server</p>
                      <p><strong>Logging:</strong> Configured to send logs to Splunk</p>
                  </div>
                  <h2>Test Links</h2>
                  <ul>
                      <li><a href="/test1.html">Test Page 1</a></li>
                      <li><a href="/test2.html">Test Page 2</a></li>
                      <li><a href="/api/status">API Status (404 - for testing)</a></li>
                  </ul>
              </div>
          </body>
          </html>

    - name: Create test pages for log generation
      ansible.windows.win_copy:
        dest: "{{ website_path }}\\{{ item.name }}"
        content: "{{ item.content }}"
      loop:
        - name: test1.html
          content: |
            <html>
            <body>
              <h1>Test Page 1</h1>
              <p>This generates access logs for Splunk analysis.</p>
              <p>Generated by Rafael's automation task</p>
            </body>
            </html>
        - name: test2.html
          content: |
            <html>
            <body>
              <h1>Test Page 2</h1>
              <p>Another test page for log generation.</p>
              <p>Server: Windows Server 2019</p>
            </body>
            </html>

    - name: Configure IIS logging using PowerShell
      ansible.windows.win_powershell:
        script: |
          Import-Module WebAdministration
          Set-WebConfigurationProperty -Filter "system.webServer/httpLogging" -Name "logFormat" -Value "W3C" -PSPath "IIS:\Sites\Default Web Site"
          Set-WebConfigurationProperty -Filter "system.webServer/httpLogging" -Name "logExtFileFlags" -Value "Date,Time,ClientIP,UserName,SiteName,ComputerName,ServerIP,Method,UriStem,UriQuery,HttpStatus,Win32Status,BytesSent,BytesRecv,TimeTaken,ServerPort,UserAgent,Cookie,Referer,ProtocolVersion,Host,HttpSubStatus" -PSPath "IIS:\Sites\Default Web Site"
          $Ansible.Result = "configured"

    - name: Verify IIS is accessible
      ansible.windows.win_uri:
        url: "http://localhost:{{ website_port }}"
        method: GET
        status_code: 200
      register: iis_test
      retries: 5
      delay: 10


- name: Fetch certificate from Windows server
  hosts: windows
  gather_facts: false
  tasks:
    - name: Fetch certificate from Windows server
      ansible.builtin.fetch:
        src: C:\temp\splunk.pfx
        dest: /tmp/splunk.pfx
        flat: yes

- name: Configure Splunk with Windows certificates
  hosts: localhost
  connection: local
  become: true
  vars:
    cert_password: "123qweA"
  tasks:
    - name: Create certs directory
      ansible.builtin.file:
        path: /opt/splunk/certs
        state: directory
        mode: '0755'

    - name: Extract certificate and key from Windows PFX
      ansible.builtin.shell: |
        openssl pkcs12 -in /tmp/splunk.pfx -nocerts -out /opt/splunk/certs/splunk-key.pem -nodes -passin pass:{{ cert_password }}
        openssl pkcs12 -in /tmp/splunk.pfx -clcerts -nokeys -out /opt/splunk/certs/splunk-cert.pem -passin pass:{{ cert_password }}
        chmod 644 /opt/splunk/certs/*.pem
      args:
        creates: /opt/splunk/certs/splunk-cert.pem

    - name: Create Splunk SSL configuration
      ansible.builtin.copy:
        dest: /opt/splunk/certs/web.conf
        mode: '0644'
        content: |
          [settings]
          enableSplunkWebSSL = true
          privKeyPath = /opt/splunk/certs/splunk-key.pem
          serverCert = /opt/splunk/certs/splunk-cert.pem

    - name: Stop and remove existing Splunk container
      community.docker.docker_container:
        name: splunk
        state: absent

    - name: Create Splunk container with Windows certificates pre-configured
      community.docker.docker_container:
        name: splunk
        image: splunk/splunk:9.1.2
        state: started
        restart_policy: always
        env:
          SPLUNK_PASSWORD: "SplunkAdmin123!"
          SPLUNK_START_ARGS: "--accept-license"
          SPLUNK_GENERAL_TERMS: "--accept-sgt-current-at-splunk-com"
          SPLUNK_ENABLE_LISTEN: "9997"
        published_ports:
          - "8000:8000"
          - "8089:8089"
          - "9997:9997"
        volumes:
          - /opt/splunk/certs:/opt/splunk/certs:rw

    - name: Wait for Splunk to start
      ansible.builtin.pause:
        seconds: 60

    - name: Copy SSL configuration into running container
      ansible.builtin.command: docker cp /opt/splunk/certs/web.conf splunk:/opt/splunk/etc/system/local/web.conf

    - name: Restart Splunk to apply SSL configuration
      ansible.builtin.command: docker restart splunk

    - name: Wait for Splunk SSL to be ready
      ansible.builtin.uri:
        url: https://localhost:8000
        method: GET
        validate_certs: no
        status_code: [200, 302]
      retries: 20
      delay: 15
      register: ssl_check
      until: ssl_check is succeeded

    - name: Clean up temporary files
      ansible.builtin.file:
        path: /tmp/splunk.pfx
        state: absent